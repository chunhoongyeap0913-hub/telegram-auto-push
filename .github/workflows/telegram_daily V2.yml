name: Telegram Daily Summary

on:
  schedule:
    - cron: '30 2 * * *'   # UTC 02:30 -> UTC+8 10:30 æ—©ä¸ŠæŽ¨é€
    - cron: '45 13 * * *'  # UTC 13:45 -> UTC+8 21:45 æ™šä¸ŠæŽ¨é€
  workflow_dispatch: {}     # æ”¯æŒæ‰‹åŠ¨è§¦å‘æµ‹è¯•

jobs:
  send_summary:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TZ: 'Asia/Shanghai'   # è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
    steps:
      - name: Show current time (for debug)
        run: |
          echo "Runner local time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "Runner UTC time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: Prepare message body
        id: build
        run: |
          H=$(date +%H)
          if [ "$H" -ge 5 ] && [ "$H" -lt 12 ]; then
            BODY="ðŸ“… $(date +'%Y-%m-%d') â€” å®è§‚æ™¨æŠ¥ & å­¦ä¹ è®¡åˆ’\n\nðŸ§­ å®è§‚è¦é—»é€Ÿè§ˆï¼š\n - \n - \n - \n\nðŸ“Š ä»Šæ—¥æ•°æ®/äº‹ä»¶ï¼š\n - \n\nðŸ“˜ å­¦ä¹ ä¸»é¢˜ï¼š\n - ç¾Žè”å‚¨ä¸Žå®è§‚é€»è¾‘ï¼ˆå½“å‰ç« èŠ‚ï¼‰\n\nðŸ“ ä»Šæ—¥å¾…åŠžï¼š\n1.\n2.\n3.\n\nâš ï¸ é£Žé™©æç¤ºï¼š\n - æ³¨æ„æ™šé—´ç¾Žå€ºæ”¶ç›ŠçŽ‡å˜åŒ–ã€‚"
          else
            BODY="ðŸŒ™ $(date +'%Y-%m-%d') â€” å¼€ç›˜å‰å¤ç›˜ç®€æŠ¥\n\nðŸ’¹ ä»Šæ—¥å¸‚åœºå›žé¡¾ï¼š\n - \n - \n\nðŸª™ æ¿å—ä¸Žçƒ­ç‚¹å‰çž»ï¼š\n - \n\nðŸ“ˆ å­¦ä¹ è¿›å±•ï¼š\n - å·²å®Œæˆç« èŠ‚/å¿ƒå¾—è¦ç‚¹ï¼š\n\nðŸ”” æ˜Žæ—¥å…³æ³¨ï¼š\n - \n\nðŸ§  ä»Šæ—¥åæ€ï¼š\n - "
          fi
          PAYLOAD=$(jq -nc --arg chat "$CHAT_ID" --arg text "$BODY" '{"chat_id":$chat, "text":$text, "disable_web_page_preview":true}')
          echo "payload=$PAYLOAD" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        if: env.TOKEN != '' && env.CHAT_ID != ''
        run: |
          echo "Sending Telegram message..."
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "${{ steps.build.outputs.payload }}" \
            -o /tmp/telegram_resp.json
          echo "Telegram API response:"
          cat /tmp/telegram_resp.json

      - name: Failure hint
        if: env.TOKEN == '' || env.CHAT_ID == ''
        run: |
          echo "::error::TELEGRAM_TOKEN or TELEGRAM_CHAT_ID not set in repo secrets. Please add them in Settings â†’ Secrets and variables â†’ Actions."
          exit 1
