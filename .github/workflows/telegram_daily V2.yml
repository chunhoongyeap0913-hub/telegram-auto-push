name: Telegram Daily Summary

on:
  schedule:
    - cron: '30 2 * * *'    # UTC 02:30 = UTC+8 10:30
    - cron: '45 13 * * *'   # UTC 13:45 = UTC+8 21:45
  workflow_dispatch: {}

jobs:
  send_summary:
    runs-on: ubuntu-latest
    env:
      TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TZ: 'Asia/Shanghai'
    steps:
      - name: Show current time (for debug)
        run: |
          echo "Runner local time: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "Runner UTC time: $(date -u +'%Y-%m-%d %H:%M:%S')"

      - name: Prepare message body
        id: build
        run: |
          H=$(date -u +%H)
          if [ "$H" -ge 2 ] && [ "$H" -lt 13 ]; then
            BODY="📰 $(date +'%Y-%m-%d') 早间宏观摘要"
          else
            BODY="🌙 $(date +'%Y-%m-%d') 美盘前简报"
          fi
          echo "BODY=$BODY" >> $GITHUB_ENV

      - name: Send to Telegram
        if: env.TOKEN != '' && env.CHAT_ID != ''
        run: |
          echo "Sending Telegram message..."
          curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${CHAT_ID}\", \"text\": \"${BODY}\"}" \
            -o /tmp/telegram_resp.json
          echo "Telegram API response:"
          cat /tmp/telegram_resp.json
